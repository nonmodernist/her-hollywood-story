<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Work Type Verification Tool - Her Hollywood Story</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            padding: 20px;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            height: calc(100vh - 40px);
        }
        
        .panel {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .panel-header {
            padding: 20px;
            border-bottom: 1px solid #eee;
            background: #fafafa;
        }
        
        .panel-body {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }
        
        h1 {
            font-size: 24px;
            margin-bottom: 10px;
        }
        
        h2 {
            font-size: 20px;
            margin-bottom: 15px;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .stat {
            text-align: center;
            padding: 10px;
            background: #f5f5f5;
            border-radius: 4px;
        }
        
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #333;
        }
        
        .stat-label {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
        }
        
        .work-list {
            list-style: none;
        }
        
        .work-item {
            padding: 15px;
            border: 1px solid #ddd;
            margin-bottom: 10px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .work-item:hover {
            background: #f5f5f5;
            border-color: #999;
        }
        
        .work-item.active {
            background: #e3f2fd;
            border-color: #2196F3;
        }
        
        .work-item.verified {
            border-left: 4px solid #4CAF50;
        }
        
        .work-title {
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .work-meta {
            font-size: 14px;
            color: #666;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        textarea {
            resize: vertical;
            min-height: 60px;
        }
        
        .afi-link {
            display: inline-block;
            margin: 10px 0;
            padding: 10px 15px;
            background: #2196F3;
            color: white;
            text-decoration: none;
            border-radius: 4px;
            font-weight: 500;
        }
        
        .afi-link:hover {
            background: #1976D2;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .btn-primary {
            background: #4CAF50;
            color: white;
        }
        
        .btn-primary:hover {
            background: #45a049;
        }
        
        .btn-secondary {
            background: #ddd;
            color: #333;
        }
        
        .btn-secondary:hover {
            background: #ccc;
        }
        
        .filters {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .filter-btn {
            padding: 6px 12px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .filter-btn.active {
            background: #2196F3;
            color: white;
            border-color: #2196F3;
        }
        
        .progress-bar {
            height: 20px;
            background: #eee;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 10px;
        }
        
        .progress-fill {
            height: 100%;
            background: #4CAF50;
            transition: width 0.3s;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .error {
            background: #ffebee;
            color: #c62828;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        
        .success {
            background: #e8f5e9;
            color: #2e7d32;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        
        /* Keyboard shortcuts hint */
        .shortcuts {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            font-size: 12px;
        }
        
        .shortcuts h3 {
            font-size: 14px;
            margin-bottom: 8px;
        }
        
        .shortcut {
            display: flex;
            justify-content: space-between;
            margin: 4px 0;
        }
        
        .key {
            background: #f5f5f5;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: monospace;
        }
        
        .films-loading {
            font-style: italic;
            color: #666;
            padding: 10px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Left Panel: Work List -->
        <div class="panel">
            <div class="panel-header">
                <h1>Works to Verify</h1>
                <div class="stats">
                    <div class="stat">
                        <div class="stat-number" id="totalCount">0</div>
                        <div class="stat-label">Total</div>
                    </div>
                    <div class="stat">
                        <div class="stat-number" id="verifiedCount">0</div>
                        <div class="stat-label">Verified</div>
                    </div>
                    <div class="stat">
                        <div class="stat-number" id="remainingCount">0</div>
                        <div class="stat-label">Remaining</div>
                    </div>
                    <div class="stat">
                        <div class="stat-number" id="progressPercent">0%</div>
                        <div class="stat-label">Progress</div>
                    </div>
                </div>
                
                <div class="progress-bar">
                    <div class="progress-fill" id="progressBar" style="width: 0%"></div>
                </div>
                
                <div class="filters">
                    <button class="filter-btn active" data-filter="all">All Works</button>
                    <button class="filter-btn" data-filter="unverified">Unverified Only</button>
                    <button class="filter-btn" data-filter="multiple">Multiple Adaptations</button>
                    <button class="filter-btn" data-filter="author">By Author</button>
                </div>
                
                <input type="text" id="searchBox" placeholder="Search works or authors..." style="margin-top: 10px;">
            </div>
            
            <div class="panel-body">
                <div class="loading" id="loadingMessage">Loading works data...</div>
                <ul class="work-list" id="workList"></ul>
            </div>
        </div>
        
        <!-- Right Panel: Verification Form -->
        <div class="panel">
            <div class="panel-header">
                <h1>Verify Work Details</h1>
            </div>
            
            <div class="panel-body" id="verifyPanel">
                <div style="text-align: center; color: #666; padding: 40px;">
                    Select a work from the list to begin verification
                </div>
            </div>
        </div>
    </div>
    
    <!-- Keyboard shortcuts -->
    <div class="shortcuts">
        <h3>Keyboard Shortcuts</h3>
        <div class="shortcut">
            <span>Next work</span>
            <span class="key">↓</span>
        </div>
        <div class="shortcut">
            <span>Previous work</span>
            <span class="key">↑</span>
        </div>
        <div class="shortcut">
            <span>Save & Next</span>
            <span class="key">Cmd+Enter</span>
        </div>
        <div class="shortcut">
            <span>Open AFI</span>
            <span class="key">Cmd+O</span>
        </div>
    </div>
    
    <script>
        // State management
        let works = [];
        let currentWork = null;
        let currentFilter = 'all';
        let verificationData = {};
        
        // Load saved verification data from localStorage
        const savedData = localStorage.getItem('workVerificationData');
        if (savedData) {
            verificationData = JSON.parse(savedData);
        }
        
        // Initialize the app
        async function init() {
            try {
                // Load works data
                const response = await fetch('../data/database/works-index.min.json');
                const data = await response.json();
                works = data.works;
                
                // Update stats
                updateStats();
                
                // Render work list
                renderWorkList();
                
                // Hide loading message
                document.getElementById('loadingMessage').style.display = 'none';
                
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('loadingMessage').innerHTML = 
                    '<div class="error">Error loading data. Please check the console.</div>';
            }
        }
        
        // Update statistics
        function updateStats() {
            const total = works.length;
            const verified = Object.keys(verificationData).length;
            const remaining = total - verified;
            const progress = Math.round((verified / total) * 100);
            
            document.getElementById('totalCount').textContent = total;
            document.getElementById('verifiedCount').textContent = verified;
            document.getElementById('remainingCount').textContent = remaining;
            document.getElementById('progressPercent').textContent = progress + '%';
            document.getElementById('progressBar').style.width = progress + '%';
        }
        
        // Render work list
        function renderWorkList() {
            const list = document.getElementById('workList');
            const searchTerm = document.getElementById('searchBox').value.toLowerCase();
            
            let filteredWorks = works;
            
            // Apply filters
            if (currentFilter === 'unverified') {
                filteredWorks = works.filter(w => !verificationData[w.id]);
            } else if (currentFilter === 'multiple') {
                filteredWorks = works.filter(w => w.adaptationCount > 1);
            }
            
            // Apply search
            if (searchTerm) {
                filteredWorks = filteredWorks.filter(w => 
                    w.title.toLowerCase().includes(searchTerm) ||
                    w.authorName.toLowerCase().includes(searchTerm)
                );
            }
            
            // Sort by adaptation count (most adapted first) then by title
            filteredWorks.sort((a, b) => {
                if (b.adaptationCount !== a.adaptationCount) {
                    return b.adaptationCount - a.adaptationCount;
                }
                return a.title.localeCompare(b.title);
            });
            
            // Render list
            list.innerHTML = filteredWorks.map(work => {
                const verified = verificationData[work.id];
                const verifiedClass = verified ? 'verified' : '';
                const workType = verified?.work_type || work.workType || 'Unknown';
                
                return `
                    <li class="work-item ${verifiedClass}" data-id="${work.id}" onclick="selectWork(${work.id})">
                        <div class="work-title">${work.title}</div>
                        <div class="work-meta">
                            ${work.authorName} · 
                            ${work.publicationYear || 'Unknown year'} · 
                            ${work.adaptationCount} film${work.adaptationCount !== 1 ? 's' : ''} · 
                            Type: <strong>${workType}</strong>
                        </div>
                    </li>
                `;
            }).join('');
        }
        
        // Generate AFI catalog URL with proper format
        function generateAFICatalogLink(afiId, title) {
            if (!afiId || !title) return null;
            
            // Clean the title for URL formatting
            const cleanTitle = title
                .replace(/^(The|A|An)\s+/i, '') // Remove leading articles
                .replace(/[^\w\s]/g, '') // Remove special characters
                .trim();
            
            // Split into first word and rest
            const words = cleanTitle.split(/\s+/);
            const firstWord = words[0].toUpperCase();
            const remainingWords = words.slice(1).join('').toUpperCase();
            
            // Build the URL
            return `https://catalog.afi.com/Film/${afiId}-${firstWord}${remainingWords ? '-' + remainingWords : ''}#2`;
        }
        
        // Select a work for verification
        async function selectWork(workId) {
            // Update active state
            document.querySelectorAll('.work-item').forEach(item => {
                item.classList.toggle('active', item.dataset.id == workId);
            });
            
            // Find the work
            currentWork = works.find(w => w.id === workId);
            if (!currentWork) return;
            
            // Load full work details
            try {
                const response = await fetch(`../data/database/work/${currentWork.slug}.json`);
                const fullWork = await response.json();
                
                // Render verification form
                renderVerificationForm(fullWork);
                
            } catch (error) {
                console.error('Error loading work details:', error);
                document.getElementById('verifyPanel').innerHTML = 
                    '<div class="error">Error loading work details</div>';
            }
        }
        
        // Render verification form
        async function renderVerificationForm(work) {
            const panel = document.getElementById('verifyPanel');
            const existingData = verificationData[work.id] || {};
            
            // Show loading state for films
            panel.innerHTML = `
                <h2>${work.html_title}</h2>
                <p style="color: #666; margin-bottom: 20px;">
                    by ${work.author.name} · 
                    ${work.adaptations.length} adaptation${work.adaptations.length !== 1 ? 's' : ''}
                </p>
                <div class="films-loading">Loading film details for AFI links...</div>
            `;
            
            // Load full film details to get AFI IDs
            const filmsWithAFI = [];
            for (const film of work.adaptations) {
                try {
                    const response = await fetch(`../data/database/film/${film.slug}.json`);
                    if (response.ok) {
                        const fullFilm = await response.json();
                        filmsWithAFI.push({
                            ...film,
                            afi_catalog_id: fullFilm.afi_catalog_id
                        });
                    } else {
                        filmsWithAFI.push(film);
                    }
                } catch (error) {
                    console.error(`Error loading film ${film.slug}:`, error);
                    filmsWithAFI.push(film);
                }
            }
            
            // Get AFI link from first film with AFI ID
            const firstFilmWithAFI = filmsWithAFI.find(f => f.afi_catalog_id);
            let afiUrl = null;
            if (firstFilmWithAFI) {
                // Get the plain title (remove italics HTML)
                const plainTitle = firstFilmWithAFI.title || firstFilmWithAFI.html_title.replace(/<[^>]*>/g, '');
                afiUrl = generateAFICatalogLink(firstFilmWithAFI.afi_catalog_id, plainTitle);
            }
            
            panel.innerHTML = `
                <h2>${work.html_title}</h2>
                <p style="color: #666; margin-bottom: 20px;">
                    by ${work.author.name} · 
                    ${work.adaptations.length} adaptation${work.adaptations.length !== 1 ? 's' : ''}
                </p>
                
                ${afiUrl ? `
                    <a href="${afiUrl}" target="_blank" class="afi-link">
                        Open AFI Catalog Entry →
                    </a>
                ` : '<p class="error">No AFI catalog ID found for films of this work</p>'}
                
                <form id="verifyForm">
                    <div class="form-group">
                        <label for="workType">Work Type *</label>
                        <select id="workType" name="work_type" required>
                            <option value="">Select type...</option>
                            <option value="novel" ${existingData.work_type === 'novel' ? 'selected' : ''}>Novel</option>
                            <option value="novella" ${existingData.work_type === 'novella' ? 'selected' : ''}>Novella</option>
                            <option value="short_story" ${existingData.work_type === 'short_story' ? 'selected' : ''}>Short Story</option>
                            <option value="poem" ${existingData.work_type === 'poem' ? 'selected' : ''}>Poem</option>
                            <option value="collection" ${existingData.work_type === 'collection' ? 'selected' : ''}>Collection</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="magazineTitle">Magazine Title</label>
                        <input type="text" id="magazineTitle" name="magazine_title" 
                               value="${existingData.magazine_title || ''}"
                               placeholder="e.g., Saturday Evening Post">
                    </div>
                    
                    <div class="form-group">
                        <label for="magazinePubDate">Magazine Publication Date</label>
                        <input type="text" id="magazinePubDate" name="magazine_pub_date"
                               value="${existingData.magazine_pub_date || ''}"
                               placeholder="e.g., March 1920">
                    </div>
                    
                    <div class="form-group">
                        <label for="magazineIssueInfo">Magazine Issue Info</label>
                        <input type="text" id="magazineIssueInfo" name="magazine_issue_info"
                               value="${existingData.magazine_issue_info || ''}"
                               placeholder="e.g., Vol. 192, No. 39">
                    </div>
                    
                    <div class="form-group">
                        <label for="serialized">
                            <input type="checkbox" id="serialized" name="serialized"
                                   ${existingData.serialized ? 'checked' : ''}
                                   style="width: auto; margin-right: 5px;">
                            Serialized?
                        </label>
                    </div>
                    
                    <div class="form-group" id="serialPartsGroup" style="${existingData.serialized ? '' : 'display: none'}">
                        <label for="serialParts">Number of Serial Parts</label>
                        <input type="number" id="serialParts" name="serial_parts"
                               value="${existingData.serial_parts || ''}"
                               min="2" placeholder="e.g., 6">
                    </div>
                    
                    <div class="form-group">
                        <label for="notes">Notes</label>
                        <textarea id="notes" name="notes"
                                  placeholder="Any additional notes about this work...">${existingData.notes || ''}</textarea>
                    </div>
                    
                    <div class="button-group">
                        <button type="submit" class="btn-primary">Save & Next</button>
                        <button type="button" class="btn-secondary" onclick="skipWork()">Skip</button>
                    </div>
                </form>
                
                <h3 style="margin-top: 30px;">Film Adaptations</h3>
                <ul style="list-style: none; padding: 0;">
                    ${filmsWithAFI.map((film, index) => {
                        let filmAFIUrl = null;
                        if (film.afi_catalog_id) {
                            const plainTitle = film.title || film.html_title.replace(/<[^>]*>/g, '');
                            filmAFIUrl = generateAFICatalogLink(film.afi_catalog_id, plainTitle);
                        }
                        
                        return `
                            <li style="padding: 10px; background: #f5f5f5; margin-bottom: 5px; border-radius: 4px;">
                                <strong>${film.html_title}</strong> (${film.year || 'Unknown'})
                                <br>
                                <span style="font-size: 14px; color: #666;">
                                    ${film.studio || 'Unknown Studio'}
                                    ${film.directors ? ` · Dir: ${film.directors}` : ''}
                                    ${filmAFIUrl ? ` · <a href="${filmAFIUrl}" target="_blank">AFI #${film.afi_catalog_id}</a>` : ''}
                                </span>
                            </li>
                        `;
                    }).join('')}
                </ul>
            `;
            
            // Add event listeners
            document.getElementById('serialized').addEventListener('change', (e) => {
                document.getElementById('serialPartsGroup').style.display = 
                    e.target.checked ? 'block' : 'none';
            });
            
            document.getElementById('verifyForm').addEventListener('submit', saveAndNext);
        }
        
        // Save and move to next
        async function saveAndNext(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const data = {
                work_id: currentWork.id,
                work_type: formData.get('work_type'),
                magazine_title: formData.get('magazine_title'),
                magazine_pub_date: formData.get('magazine_pub_date'),
                magazine_issue_info: formData.get('magazine_issue_info'),
                serialized: formData.get('serialized') === 'on',
                serial_parts: formData.get('serial_parts') ? parseInt(formData.get('serial_parts')) : null,
                notes: formData.get('notes'),
                verified_at: new Date().toISOString()
            };
            
            // Save to verification data
            verificationData[currentWork.id] = data;
            
            // Save to localStorage
            localStorage.setItem('workVerificationData', JSON.stringify(verificationData));
            
            // Update stats
            updateStats();
            
            // Update list
            renderWorkList();
            
            // Show success message
            const successMsg = document.createElement('div');
            successMsg.className = 'success';
            successMsg.textContent = 'Saved! Moving to next work...';
            document.getElementById('verifyPanel').prepend(successMsg);
            
            // Move to next unverified work
            setTimeout(() => {
                const unverifiedWorks = works.filter(w => !verificationData[w.id]);
                if (unverifiedWorks.length > 0) {
                    selectWork(unverifiedWorks[0].id);
                } else {
                    document.getElementById('verifyPanel').innerHTML = 
                        '<div class="success" style="text-align: center; padding: 40px;">All works verified! 🎉</div>';
                }
            }, 500);
        }
        
        // Skip current work
        function skipWork() {
            const unverifiedWorks = works.filter(w => !verificationData[w.id] && w.id !== currentWork.id);
            if (unverifiedWorks.length > 0) {
                selectWork(unverifiedWorks[0].id);
            }
        }
        
        // Export data function
        function exportData() {
            const dataStr = JSON.stringify(verificationData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `work-verification-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
        }
        
        // Event listeners
        document.addEventListener('DOMContentLoaded', init);
        
        // Filter buttons
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('filter-btn')) {
                currentFilter = e.target.dataset.filter;
                document.querySelectorAll('.filter-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.filter === currentFilter);
                });
                renderWorkList();
            }
        });
        
        // Search box
        document.getElementById('searchBox').addEventListener('input', renderWorkList);
        
        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            // Cmd+Enter to save and next
            if (e.metaKey && e.key === 'Enter' && currentWork) {
                document.getElementById('verifyForm')?.dispatchEvent(new Event('submit'));
            }
            
            // Cmd+O to open AFI
            if (e.metaKey && e.key === 'o' && currentWork) {
                e.preventDefault();
                const afiLink = document.querySelector('.afi-link');
                if (afiLink) afiLink.click();
            }
            
            // Arrow keys to navigate
            if (e.key === 'ArrowDown' || e.key === 'ArrowUp') {
                e.preventDefault();
                const items = Array.from(document.querySelectorAll('.work-item'));
                const currentIndex = items.findIndex(item => item.classList.contains('active'));
                let nextIndex = currentIndex;
                
                if (e.key === 'ArrowDown') {
                    nextIndex = Math.min(currentIndex + 1, items.length - 1);
                } else {
                    nextIndex = Math.max(currentIndex - 1, 0);
                }
                
                if (nextIndex !== currentIndex && items[nextIndex]) {
                    const nextId = items[nextIndex].dataset.id;
                    selectWork(parseInt(nextId));
                    items[nextIndex].scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }
        });
        
        // Add export button to page
        window.addEventListener('load', () => {
            const exportBtn = document.createElement('button');
            exportBtn.textContent = 'Export Data';
            exportBtn.className = 'btn-primary';
            exportBtn.style.position = 'fixed';
            exportBtn.style.bottom = '20px';
            exportBtn.style.left = '20px';
            exportBtn.onclick = exportData;
            document.body.appendChild(exportBtn);
        });
    </script>
</body>
</html>
